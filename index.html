<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Newhouse Forum</title>

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@400" />

<style>
*,*::before,*::after{box-sizing:border-box;}

:root{
  --blue:#0468fe;
  --yellow:#FFD84D;
  --bg:#0b0f1a;
  --panel:#141a2b;
  --panel2:#11182a;
  --text:#fff;
  --muted:rgba(255,255,255,.6);
  --field:#0f1526;
  --overlay:rgba(0,0,0,.6);
}

@media(prefers-color-scheme:light){
  :root{
    --bg:#f6f7fb;
    --panel:#fff;
    --panel2:#fff;
    --text:#0b0f1a;
    --muted:rgba(0,0,0,.55);
    --field:#f1f3f7;
    --overlay:rgba(0,0,0,.35);
  }
}

body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* HEADER */
header{
  background:var(--blue);
  padding:12px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:700;
}
header .right{display:flex;gap:10px;align-items:center;}

.iconBtn,.btnAdd{
  height:42px;
  border:none;
  border-radius:10px;
  background:var(--yellow);
  cursor:pointer;
  color:#111;
  font-weight:800;
}

.iconBtn{
  width:42px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.iconBtn .material-symbols-rounded{font-size:22px; line-height:1;}

.btnAdd{
  padding:0 14px;
  display:flex;
  align-items:center;
  gap:8px;
}
.btnAdd .addIcon{display:none;}

@media(max-width:500px){
  .btnAdd{width:42px;padding:0; justify-content:center;}
  .btnAdd .addText{display:none;}
  .btnAdd .addIcon{display:flex;font-size:22px; line-height:1;}
}

/* CONTENT */
#threadList,#threadView{
  padding:20px;
  max-width:760px;
  margin:auto;
}

.card{
  background:var(--panel);
  padding:14px 16px;
  border-radius:14px;
  margin-bottom:12px;
}

.card.clickable{cursor:pointer;}
.card small{color:var(--muted);}

.preview{
  color:var(--muted);
  font-size:14px;
  margin-top:6px;
  display:-webkit-box;
  -webkit-line-clamp:3;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

.metaRow{
  margin-top:8px;
  display:flex;
  align-items:center;
  gap:8px;
  color:var(--muted);
  font-size:13px;
}

.metaRow .material-symbols-rounded{
  font-size:18px;
  line-height:1;
  vertical-align:middle;
  opacity:.95;
}

.locked{
  color:#ff4d4d;
  font-weight:800;
}

/* EMPTY */
#empty{
  text-align:center;
  margin-top:80px;
  color:var(--muted);
}

/* MODALS */
.modal{
  position:fixed;
  inset:0;
  background:var(--overlay);
  display:none;
  justify-content:center;
  align-items:center;
  padding:16px;
}
.modal.show{display:flex;}

.modalContent{
  background:var(--panel2);
  padding:20px;
  border-radius:14px;
  width:100%;
  max-width:420px;
}

input,textarea{
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.15);
  background:var(--field);
  color:var(--text);
}

.modalActions{
  display:flex;
  gap:10px;
  margin-top:10px;
}

.btnYellow{background:var(--yellow);color:#111;}
.btnRed{background:#ff4d4d;color:white;}
.btnGhost{
  background:transparent;
  color:var(--text);
  border:1px solid rgba(255,255,255,.2);
}
</style>
</head>

<body>

<header>
  <span style="font-size:28px;color:white">Newhouse Forum</span>
  <div class="right">
    <button class="btnAdd" onclick="openNewThread()">
      <span class="addText">+ New Thread</span>
      <span class="material-symbols-rounded addIcon">add</span>
    </button>
    <button class="iconBtn" id="adminBtn" onclick="enterAdmin()" disabled aria-label="Admin Key">
      <span class="material-symbols-rounded">key</span>
    </button>
  </div>
</header>

<div id="empty" style="display:none;">No threads yet.</div>
<div id="threadList"></div>
<div id="threadView" style="display:none;"></div>

<!-- NEW THREAD MODAL -->
<div class="modal" id="threadModal">
  <div class="modalContent">
    <h3>New Thread</h3>
    <input id="threadTitle" placeholder="Title">
    <textarea id="threadBody" placeholder="Body"></textarea>

    <div class="modalActions">
      <button class="btnYellow" onclick="postThread()">Post</button>
      <button class="btnGhost" onclick="closeThreadModal()">Cancel</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
import {
  getFirestore, collection, doc, addDoc, getDoc, getDocs,
  onSnapshot, updateDoc, deleteDoc, serverTimestamp, increment
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyAplfN5_ye00-NBeTdV9_N1uJ0w2BDV-X0",
  authDomain: "newhouse-forum.firebaseapp.com",
  projectId: "newhouse-forum",
  storageBucket: "newhouse-forum.firebasestorage.app",
  messagingSenderId: "1000240641292",
  appId: "1:1000240641292:web:2e1459957606ca35fc0529",
  measurementId: "G-05MYHQZMBG"
};

const app = initializeApp(firebaseConfig);
getAnalytics(app);
const db = getFirestore(app);

/* STATE */
let threads = [];
let currentThread = null;
let isAdmin = false;
let ADMIN_KEY = null;
let adminLoaded = false;

/* LOAD ADMIN KEY */
async function loadAdminKey(){
  try{
    const snap = await getDoc(doc(db,"config","forum"));
    if(snap.exists()) ADMIN_KEY = snap.data().adminKey;
  }catch(e){
    console.error("Admin config load failed:", e);
  }finally{
    adminLoaded = true;
    adminBtn.disabled = false;
  }
}
loadAdminKey();

/* ADMIN */
window.enterAdmin = () => {
  if(!adminLoaded) return alert("Loading admin config‚Ä¶");
  if(!ADMIN_KEY) return alert("Admin config missing (config/forum.adminKey)");

  const k = prompt("Admin key:");
  if(k === ADMIN_KEY){
    isAdmin = true;
    alert("Admin mode enabled");
    currentThread ? openThread(currentThread) : renderThreads();
  }else{
    alert("Wrong key");
  }
};

/* THREAD LIST LIVE */
onSnapshot(collection(db,"threads"), snap=>{
  threads = [];
  snap.forEach(d=>threads.push({id:d.id, ...d.data()}));
  renderThreads();
});

function renderThreads(){
  currentThread = null;
  threadView.style.display = "none";
  threadList.style.display = "block";
  threadList.innerHTML = "";

  if(!threads.length){
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";

  threads
    .sort((a,b)=> (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0))
    .forEach(t=>{
      const div = document.createElement("div");
      div.className = "card clickable";

      const count = Number.isFinite(t.commentCount) ? t.commentCount : 0;
      const dateStr = t.createdAt?.toDate ? t.createdAt.toDate().toLocaleString() : "";

      div.innerHTML = `
        <b>${escape(t.title)}</b>
        ${t.locked ? ` <span class="locked">üîí</span>` : ""}
        <div class="preview">${escape(t.body || "")}</div>

        <div class="metaRow">
          <span class="material-symbols-rounded">comment</span>
          <span>${count}</span>
          <span>‚Ä¢</span>
          <span>${escape(dateStr)}</span>
        </div>
      `;

      div.onclick = ()=>openThread(t);
      threadList.appendChild(div);
    });
}

/* THREAD VIEW */
async function openThread(t){
  currentThread = t;
  threadList.style.display = "none";
  threadView.style.display = "block";

  const count = Number.isFinite(t.commentCount) ? t.commentCount : 0;
  const dateStr = t.createdAt?.toDate ? t.createdAt.toDate().toLocaleString() : "";

  threadView.innerHTML = `
    <button class="btnGhost" onclick="goBack()">‚Üê Back</button>

    <div class="card">
      <h3 style="margin:0 0 8px 0;">${escape(t.title)} ${t.locked ? "üîí" : ""}</h3>
      <div class="metaRow" style="margin-top:0;margin-bottom:10px;">
        <span class="material-symbols-rounded">comment</span>
        <span>${count}</span>
        <span>‚Ä¢</span>
        <span>${escape(dateStr)}</span>
      </div>
      <p style="margin:0;">${escape(t.body || "")}</p>

      ${isAdmin ? `
        <div class="modalActions">
          <button class="btnGhost" onclick="toggleLock()">Toggle Lock</button>
          <button class="btnRed" onclick="deleteThread()">Delete Thread</button>
        </div>` : ""
      }
    </div>

    <h4>Comments</h4>
    <div id="comments"></div>

    ${t.locked
      ? `<p class="locked">Thread locked.</p>`
      : `
        <textarea id="commentInput" placeholder="Write a comment"></textarea>
        <button class="btnYellow" onclick="postComment()">Post Comment</button>
      `}
  `;

  const snap = await getDocs(collection(db,"threads",t.id,"comments"));
  const box = document.getElementById("comments");

  snap.forEach(d=>{
    const c = d.data();
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      ${escape(c.body || "")}
      ${isAdmin ? `<div class="modalActions"><button class="btnRed" onclick="deleteComment('${d.id}')">Delete</button></div>` : ""}
    `;
    box.appendChild(div);
  });
}

/* BACK */
window.goBack = () => renderThreads();

/* MODAL */
window.openNewThread = ()=>threadModal.classList.add("show");
window.closeThreadModal = ()=>threadModal.classList.remove("show");

/* CREATE THREAD */
window.postThread = async ()=>{
  const title = threadTitle.value.trim();
  const body  = threadBody.value.trim();
  if(!title || !body) return alert("Fill everything");

  await addDoc(collection(db,"threads"),{
    title,
    body,
    locked:false,
    commentCount: 0,
    createdAt: serverTimestamp()
  });

  threadTitle.value = "";
  threadBody.value = "";
  closeThreadModal();
};

/* ADD COMMENT + INCREMENT COUNT */
window.postComment = async ()=>{
  const text = commentInput.value.trim();
  if(!text) return;

  await addDoc(
    collection(db,"threads",currentThread.id,"comments"),
    { body:text, createdAt: serverTimestamp() }
  );

  await updateDoc(
    doc(db,"threads",currentThread.id),
    { commentCount: increment(1) }
  );

  // Refresh view
  openThread({ ...currentThread, commentCount:(currentThread.commentCount||0)+1 });
};

/* ADMIN: LOCK/UNLOCK */
window.toggleLock = async ()=>{
  if(!isAdmin) return;
  await updateDoc(doc(db,"threads",currentThread.id),{
    locked: !currentThread.locked
  });
};

/* ADMIN: DELETE THREAD */
window.deleteThread = async ()=>{
  if(!isAdmin) return;
  if(confirm("Delete thread?")){
    await deleteDoc(doc(db,"threads",currentThread.id));
    renderThreads();
  }
};

/* ADMIN: DELETE COMMENT + DECREMENT COUNT */
window.deleteComment = async (commentId)=>{
  if(!isAdmin) return;

  await deleteDoc(doc(db,"threads",currentThread.id,"comments",commentId));

  await updateDoc(
    doc(db,"threads",currentThread.id),
    { commentCount: increment(-1) }
  );

  // Refresh view (safe)
  openThread({ ...currentThread, commentCount: Math.max(0,(currentThread.commentCount||0)-1) });
};

/* UTILS */
function escape(str){
  return String(str).replace(/[&<>"']/g,m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[m]));
}
</script>

</body>
</html>
