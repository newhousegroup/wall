<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Newhouse Forum</title>

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:wght@400" />

<style>
*,*::before,*::after{box-sizing:border-box;}

:root{
  --blue:#0468fe;
  --yellow:#FFD84D;
  --bg:#0b0f1a;
  --panel:#141a2b;
  --panel2:#11182a;
  --text:#fff;
  --muted:rgba(255,255,255,.6);
  --field:#0f1526;
  --overlay:rgba(0,0,0,.6);
}

@media(prefers-color-scheme:light){
  :root{
    --bg:#f6f7fb;
    --panel:#fff;
    --panel2:#fff;
    --text:#0b0f1a;
    --muted:rgba(0,0,0,.55);
    --field:#f1f3f7;
    --overlay:rgba(0,0,0,.35);
  }
}

body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* HEADER */
header{
  background:var(--blue);
  padding:12px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:700;
}
header .right{display:flex;gap:10px;align-items:center;}

.iconBtn,.btnAdd{
  height:42px;
  border:none;
  border-radius:10px;
  background:var(--yellow);
  cursor:pointer;
  color:#111;
  font-weight:700;
}

.iconBtn{
  width:42px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.iconBtn .material-symbols-rounded{font-size:22px;}

.btnAdd{
  padding:0 14px;
  display:flex;
  align-items:center;
  gap:8px;
}
.btnAdd .addIcon{display:none;}

@media(max-width:500px){
  .btnAdd{width:42px;padding:0;}
  .btnAdd .addText{display:none;}
  .btnAdd .addIcon{display:block;font-size:22px;}
}

/* CONTENT */
#threadList,#threadView{
  padding:20px;
  max-width:760px;
  margin:auto;
}

.card{
  background:var(--panel);
  padding:14px 16px;
  border-radius:14px;
  margin-bottom:12px;
}

.card.clickable{cursor:pointer;}
.card small{color:var(--muted);}

.locked{
  color:#ff4d4d;
  font-weight:700;
}

/* EMPTY */
#empty{
  text-align:center;
  margin-top:80px;
  color:var(--muted);
}

/* MODALS */
.modal{
  position:fixed;
  inset:0;
  background:var(--overlay);
  display:none;
  justify-content:center;
  align-items:center;
  padding:16px;
}
.modal.show{display:flex;}

.modalContent{
  background:var(--panel2);
  padding:20px;
  border-radius:14px;
  width:100%;
  max-width:420px;
}

input,textarea{
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.15);
  background:var(--field);
  color:var(--text);
}

.modalActions{
  display:flex;
  gap:10px;
  margin-top:10px;
}

.btnYellow{background:var(--yellow);color:#111;}
.btnRed{background:#ff4d4d;color:white;}
.btnGhost{
  background:transparent;
  color:var(--text);
  border:1px solid rgba(255,255,255,.2);
}
</style>
</head>

<body>

<header>
  <span style="font-size:28px">üßµ Newhouse Forum</span>
  <div class="right">
    <button class="btnAdd" onclick="openNewThread()">
      <span class="addText">+ New Thread</span>
      <span class="material-symbols-rounded addIcon">add</span>
    </button>
    <button class="iconBtn" onclick="enterAdmin()">
      <span class="material-symbols-rounded">key</span>
    </button>
  </div>
</header>

<div id="empty" style="display:none;">No threads yet.</div>
<div id="threadList"></div>
<div id="threadView" style="display:none;"></div>

<!-- NEW THREAD MODAL -->
<div class="modal" id="threadModal">
  <div class="modalContent">
    <h3>New Thread</h3>
    <input id="threadTitle" placeholder="Title">
    <textarea id="threadBody" placeholder="Body"></textarea>

    <div class="modalActions">
      <button class="btnYellow" onclick="postThread()">Post</button>
      <button class="btnGhost" onclick="closeThreadModal()">Cancel</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
import {
  getFirestore, collection, doc, addDoc, getDoc, getDocs,
  onSnapshot, updateDoc, deleteDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ---------- FIREBASE ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyAplfN5_ye00-NBeTdV9_N1uJ0w2BDV-X0",
  authDomain: "newhouse-forum.firebaseapp.com",
  projectId: "newhouse-forum",
  storageBucket: "newhouse-forum.firebasestorage.app",
  messagingSenderId: "1000240641292",
  appId: "1:1000240641292:web:2e1459957606ca35fc0529",
  measurementId: "G-05MYHQZMBG"
};

const app = initializeApp(firebaseConfig);
getAnalytics(app);
const db = getFirestore(app);

/* ---------- STATE ---------- */
let threads = [];
let currentThread = null;
let isAdmin = false;
let ADMIN_KEY = null;

/* ---------- LOAD ADMIN KEY ---------- */
async function loadAdminKey(){
  const snap = await getDoc(doc(db,"config","forum"));
  if(snap.exists()) ADMIN_KEY = snap.data().adminKey;
}
loadAdminKey();

/* ---------- ADMIN ---------- */
window.enterAdmin = () => {
  if(!ADMIN_KEY){
    alert("Admin config not loaded yet.");
    return;
  }
  const k = prompt("Admin key:");
  if(k === ADMIN_KEY){
    isAdmin = true;
    alert("Admin mode enabled");
    currentThread ? openThread(currentThread) : renderThreads();
  }else{
    alert("Wrong key");
  }
};

/* ---------- THREAD LIST ---------- */
onSnapshot(collection(db,"threads"), snap=>{
  threads = [];
  snap.forEach(d=>threads.push({id:d.id,...d.data()}));
  renderThreads();
});

function renderThreads(){
  threadView.style.display="none";
  threadList.style.display="block";
  threadList.innerHTML="";

  if(!threads.length){
    empty.style.display="block";
    return;
  }
  empty.style.display="none";

  threads
    .sort((a,b)=>b.createdAt?.seconds - a.createdAt?.seconds)
    .forEach(t=>{
      const div=document.createElement("div");
      div.className="card clickable";
      div.innerHTML=`
        <b>${escape(t.title)}</b>
        ${t.locked?` <span class="locked">üîí</span>`:""}
        <br>
        <small>${t.createdAt?.toDate().toLocaleString()||""}</small>
      `;
      div.onclick=()=>openThread(t);
      threadList.appendChild(div);
    });
}

/* ---------- THREAD VIEW ---------- */
async function openThread(t){
  currentThread = t;
  threadList.style.display="none";
  threadView.style.display="block";

  threadView.innerHTML=`
    <button class="btnGhost" onclick="renderThreads()">‚Üê Back</button>

    <div class="card">
      <h3>${escape(t.title)} ${t.locked?"üîí":""}</h3>
      <p>${escape(t.body)}</p>

      ${isAdmin?`
        <div class="modalActions">
          <button class="btnGhost" onclick="toggleLock()">Toggle Lock</button>
          <button class="btnRed" onclick="deleteThread()">Delete Thread</button>
        </div>`:""}
    </div>

    <h4>Comments</h4>
    <div id="comments"></div>

    ${t.locked
      ? `<p class="locked">Thread locked.</p>`
      : `
        <textarea id="commentInput" placeholder="Write a comment"></textarea>
        <button class="btnYellow" onclick="postComment()">Post Comment</button>
      `}
  `;

  const snap = await getDocs(collection(db,"threads",t.id,"comments"));
  const box = document.getElementById("comments");

  snap.forEach(d=>{
    const c=d.data();
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      ${escape(c.body)}
      ${isAdmin?`<button class="btnRed" onclick="deleteComment('${d.id}')">Delete</button>`:""}
    `;
    box.appendChild(div);
  });
}

/* ---------- ACTIONS ---------- */
window.openNewThread = ()=>threadModal.classList.add("show");
window.closeThreadModal = ()=>threadModal.classList.remove("show");

window.postThread = async ()=>{
  const title = threadTitle.value.trim();
  const body  = threadBody.value.trim();
  if(!title||!body) return alert("Fill everything");

  await addDoc(collection(db,"threads"),{
    title, body,
    locked:false,
    createdAt:serverTimestamp()
  });

  threadTitle.value="";
  threadBody.value="";
  closeThreadModal();
};

window.postComment = async ()=>{
  const text = commentInput.value.trim();
  if(!text) return;

  await addDoc(collection(db,"threads",currentThread.id,"comments"),{
    body:text,
    createdAt:serverTimestamp()
  });

  openThread(currentThread);
};

window.toggleLock = async ()=>{
  if(!isAdmin) return;
  await updateDoc(doc(db,"threads",currentThread.id),{
    locked:!currentThread.locked
  });
};

window.deleteThread = async ()=>{
  if(!isAdmin) return;
  if(confirm("Delete thread?")){
    await deleteDoc(doc(db,"threads",currentThread.id));
    renderThreads();
  }
};

window.deleteComment = async (id)=>{
  if(!isAdmin) return;
  await deleteDoc(doc(db,"threads",currentThread.id,"comments",id));
  openThread(currentThread);
};

/* ---------- UTILS ---------- */
function escape(str){
  return str.replace(/[&<>"']/g,m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
  }[m]));
}
</script>
</body>
</html>
